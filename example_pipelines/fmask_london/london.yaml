configurations:
  eo_pipelines:
    properties:
      spec:
        lat_min: 51.3
        lat_max: 51.7
        lon_min: -0.2
        lon_max: 0.1
        start_date: "2023-07-01"
        end_date: "2023-07-30"
        max_cloud_cover_fraction: 1
        datasets:
          LANDSAT_OT_C2_L1:
            bands: [ B1, B2, B3, B4, B5, B6, B7, B8, B9, B10, B11, QA_PIXEL, VAA, VZA, SAA, SZA ]
      environment:
        working_directory: .
        conda_path: /home/dev/miniforge3/bin/conda
        shell: "/bin/bash"
        echo_stdout: True
nodes:
  n0:
    type: eo_pipelines:usgs_search
    properties:
      configuration:
        row: 24
        path: 201
      executor_settings:
        can_skip: true
  n1:
    type: eo_pipelines:usgs_fetch
    properties:
      configuration:
        output_path: fetched
      executor_settings:
        can_skip: true
  n2:
    type: eo_pipelines:apply_fmask
    properties:
      executor_settings:
        can_skip: 4
        executor: local
        local:
          nr_threads: 1
      configuration:
        output_path: masked
        model: UPL
        fmask_home: /home/dev/Tools/fmask/fmask
        dataset: LANDSAT_OT_C2_L1
  n3:
    type: eo_pipelines:landsat_import
    properties:
      executor_settings:
        can_skip: 4
        executor: local
        local:
          nr_threads: 1
      configuration:
        output_path: imported
        extra_bands:
          LANDSAT_OT_C2_L1:
            - UPL
  grid:
    type: eo_pipelines:create_grid
    properties:
      configuration:
        resolution: 50
  n4:
    type: eo_pipelines:regrid
    properties:
      configuration:
        variables:
          - B1:nearest:B1
          - B2:nearest:B2
          - B3:nearest:B3
          - B4:nearest:B4
          - B5:nearest:B5
          - B6:nearest:B6
          - B7:nearest:B7
          - B9:nearest:B9
          - B10:nearest:B10
          - B11:nearest:B11
          - QA_PIXEL:nearest:QA_PIXEL
          - ST:nearest:ST
          - UPL:nearest:UPL
          - ST_QA:nearest:ST_QA
        source_x: "lon"
        source_y: "lat"
        source_crs: 4326
        target_x: "lon"
        target_y: "lat"
        target_crs: 4326
        output_path: regridded
      executor_settings:
        can_skip: true
        executor: local
        local:
          nr_threads: 4
  n5:
    type: eo_pipelines:group
    properties:
      configuration:
        output_path: grouped
      executor_settings:
        can_skip: true
  n6:
    type: eo_pipelines:time_stacker
    properties:
      configuration:
        output_filename: stacked.nc
        output_path: stacked
      executor_settings:
        can_skip: true          -
  n7:
    type: eo_pipelines:generate_html
    properties:
      configuration:
        output_folder: html
        title: FMask Results
        download_data: true
        specification:
          dimensions:
            case: time
            x: ni
            y: nj
          coordinates:
            x: lon
            y: lat
            time: time
          image:
            grid-width: 250   # the width of the images presented in the grid view
            max-zoom: 10      # the maximum zoom allowed in overlay view
          info:
            Date: "${str(data[\"time\"].data)[0:10]}"
          derive_bands:
            CLOUD_MASK_JPL: "not (QA_PIXEL & 30 == 0)"
            CLOUD_MASK_FMASK: "(UPL == 2) or (UPL == 4)"
          layers:
            cloud_mask_jpl:
              label: "JPL Cloud Mask (30)"
              type: "mask"
              band: "CLOUD_MASK_JPL"
              r: 150
              g: 150
              b: 150
            cloud_mask_fmask:
              label: "FMask Cloud Mask"
              type: "mask"
              band: "CLOUD_MASK_FMASK"
              r: 75
              g: 75
              b: 75
            B10:
              type: single
              band: B10
              min_value: 260
              max_value: 325
              cmap: coolwarm
              data:
                label: "B10: {value} K"
                fixed: 2
            "False Colour":
              type: rgb
              red_band: B4
              green_band: B3
              blue_band: B2
            "OSM":
              label: "Open Street Map"
              type: "wms"
              scale: 1
              url: "https://eocis.org/mapproxy/service?service=WMS&request=GetMap&layers=osm&styles=&format=image%2Fpng&transparent=false&version=1.1.1&width={WIDTH}&height={HEIGHT}&srs=EPSG%3A4326&bbox={XMIN},{YMIN},{XMAX},{YMAX}"

links:
  - n0 => n1
  - n1 => n2
  - n2 => n3
  - n3:output => n4:input
  - grid:output => n4:input_grid
  - n4 => n5
  - n5 => n6
  - n6 => n7